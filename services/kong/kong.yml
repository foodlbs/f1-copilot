_format_version: "3.0"

# ==================== UPSTREAMS ====================
upstreams:
  - name: rag-service-upstream
    algorithm: round-robin
    healthchecks:
      active:
        type: http
        http_path: /health
        timeout: 5
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
    targets:
      - target: rag-service:8001
        weight: 100

# ==================== SERVICES ====================
services:
  # ========== RAG Service ==========
  - name: rag-service
    host: rag-service-upstream
    port: 8001
    protocol: http
    connect_timeout: 120000
    write_timeout: 120000
    read_timeout: 120000
    retries: 3

    routes:
      - name: api-route
        paths:
          - /api
        methods:
          - GET
          - POST
          - DELETE
          - OPTIONS
        strip_path: true

    plugins:
      - name: rate-limiting
        config:
          second: 10
          minute: 100
          hour: 1000
          policy: local
          fault_tolerant: true

      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - DELETE
            - OPTIONS
          headers:
            - "*"
          credentials: true
          max_age: 3600

      - name: request-size-limiting
        config:
          allowed_payload_size: 10
          size_unit: megabytes

      - name: response-transformer
        config:
          add:
            headers:
              - "X-Service:RAG-Service"

      - name: prometheus
        config:
          per_consumer: true

# ==================== GLOBAL PLUGINS ====================
plugins:
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
